{% extends "page.html" %}

{% block title %}
{{ _('Download status') }}
{% endblock %}

{% block breadcrumb_content %}
<li class="active">
    <a class="active" href="{{ h.url_for('datastore_status.download_status', download_id=download_request.id) }}">Download
                                                                                          status</a>
</li>
{% endblock %}

{% block primary_content %}
{% asset 'ckanext-versioned-datastore/download-status-css' %}
<article class="module">
    <div class="module-content">
        <h1 class="page-heading">{{ download_request.state | capitalize }}: {{ download_request.id }}</h1>

        <section class="additional-info">
            <h3>Download Information</h3>
            <table class="table table-striped table-bordered table-condensed">
                <tbody>
                <tr>
                    <th scope="row">ID</th>
                    <td>{{ download_request.id }}</td>
                </tr>
                <tr>
                    <th scope="row">Status</th>
                    <td>{{ download_request.state }}</td>
                </tr>
                {% if download_request.state == 'failed' %}
                <tr>
                    <th scope="row">Error</th>
                    <td>{{ download_request.message }}</td>
                </tr>
                {% endif %}
                <tr>
                    <th scope="row">Created</th>
                    <td>{{ download_request.created.strftime('%Y-%m-%d') }}</td>
                </tr>
                {% if download_request.derivative_record %}
                <tr>
                    <th scope="row">Format</th>
                    <td>
                        {{ download_request.derivative_record.format }}
                        <dl>
                            {% for k, v in download_request.derivative_record.options.get('format_args', {}).items() %}
                            <dt>{{ k }}</dt>
                            <dd><code>{{ v }}</code></dd>
                            {% endfor %}
                        </dl>
                    </td>
                </tr>
                <tr>
                    <th scope="row">Resources in separate files</th>
                    <td>{{ download_request.derivative_record.options.get('separate_files', True) }}</td>
                </tr>
                <tr>
                    <th scope="row">Ignore empty fields</th>
                    <td>{{ download_request.derivative_record.options.get('ignore_empty_fields', True) }}</td>
                </tr>
                {% endif %}
                {% if download_request.core_record %}
                <tr>
                    <th scope="row">Records</th>
                    <td>
                        <dl>
                            <dt>Total</dt>
                            <dd>{{ download_request.core_record.total }}</dd>
                            {% if download_request.core_record.resource_totals %}
                            {% for res_id, res in resources.items() %}
                            <dt>{{ res['name'] }}</dt>
                            <dd>{{ download_request.core_record.resource_totals[res_id] }}</dd>
                            {% endfor %}
                            {% endif %}
                        </dl>
                    </td>
                </tr>
                {% endif %}
                </tbody>
            </table>
        </section>
    </div>
</article>
{% endblock %}

{% block secondary_content %}
<div class="module module-narrow module-shallow">
    {% if 'filters' in download_request.query %}
    <h2 class="module-heading">
        <i class="fas fa-info-circle inline-icon-left"></i>
        {{ _('Filters') }}
    </h2>
    <div class="module-content">
        {% for group_name, filters_and_subgroups in download_request.query['filters'].items() recursive %}
        {% set outer_loop = loop %}
        <div style="margin-left: {{ 10 * outer_loop.depth0 }}px; padding-left: 10px; border-left: 1px solid #cccccc">
            <b>{{ {'and': 'all', 'or': 'any', 'not': 'none'}[group_name] }}:</b>
            {% for filter_or_group in filters_and_subgroups %}
            {% set group_key = filter_or_group.keys() | first %}
            {% if group_key in ['and', 'or', 'not'] %}
            {{ outer_loop(filter_or_group.items()) }}
            {% else %}
            <pre>{{ filter_or_group | tojson(indent=2) }}</pre>
            {% endif %}
            {% endfor %}
        </div>

        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}